# 增强日志功能使用指南

## 概述

为了解决测试调用过程中缺少详细日志信息的问题，我们提供了增强日志功能，让用户能够看到：

- 📞 每次API调用的详细信息
- ⏱️ 实时响应时间和延迟
- 💰 每次调用的成本和累计成本
- 🔢 Token使用情况（输入/输出/总计）
- 📊 阈值达成进度条
- 🎯 告警阈值检查状态
- 💳 预算使用情况
- 📈 CloudWatch指标状态

## 新增文件

### 1. `enhanced_logger.py`
- 核心日志工具类
- 支持Rich彩色输出（可选）
- 提供各种日志方法

### 2. `single_test_enhanced_logs.py`
- 基于原有测试脚本的增强版
- 集成详细日志输出
- 保持原有功能不变

### 3. `run_enhanced_logs.sh`
- 快速启动脚本
- 自动检查依赖
- 一键运行测试

## 快速开始

### 方法1: 使用脚本运行
```bash
cd tests/e2e
./run_enhanced_logs.sh
```

### 方法2: 直接运行Python
```bash
cd tests/e2e
python3 single_test_enhanced_logs.py
```

## 日志输出示例

### 基础输出（无Rich库）
```
17:34:05.123 🚀 初始化测试器
17:34:05.124 🏢 租户ID: demo1
17:34:05.125 📱 应用ID: test-app
17:34:05.126 💰 成本告警阈值: $0.01
17:34:05.127 🔢 Token告警阈值: 1000

17:34:05.128 📞 调用 #1: '什么是云计算？' | 租户: demo1 | 应用: test-app
17:34:06.234 ✅ 响应成功 | 延迟: 1.11s | 成本: $0.001234 | Token: 60 (输入:15, 输出:45)
17:34:06.235 📊 累计统计 | 调用: 1 | 成本: $0.001234 | Token: 60
17:34:06.236 🎯 阈值进度 | 成本: 12.3% [█░░░░░░░░░] | Token: 6.0% [░░░░░░░░░░]
```

### Rich彩色输出
- 彩色时间戳
- 彩色状态指示
- 进度条可视化
- 表格化仪表板

## 主要改进

### 1. 详细的API调用日志
- 调用前：显示调用序号、prompt内容、租户和应用ID
- 调用后：显示响应时间、成本、Token详情
- 失败时：显示错误码和错误信息

### 2. 实时统计信息
- 累计调用次数
- 累计成本和Token使用
- 成功/失败调用统计

### 3. 阈值进度可视化
- 成本阈值达成百分比
- Token阈值达成百分比
- 可视化进度条

### 4. 预算和指标详情
- 预算使用情况详细展示
- CloudWatch指标查询状态
- 5分钟窗口数据展示

### 5. 测试总结报告
- 完整的测试执行统计
- 平均成本和Token使用
- 成功率分析

## 配置选项

### 修改阈值
在 `single_test_enhanced_logs.py` 中修改：
```python
self.cost_threshold = 0.01  # 成本阈值
self.token_threshold = 1000  # Token阈值
```

### 修改租户信息
```python
tester = EnhancedTester("your-tenant-id", "your-app-id")
```

### 禁用Rich彩色输出
```python
logger = TestLogger(enable_rich=False)
```

## 依赖要求

### 必需依赖
- `requests`
- `boto3`

### 可选依赖（推荐）
- `rich` - 提供彩色输出和更好的可视化

### 安装依赖
```bash
pip3 install requests boto3 rich
```

## 故障排除

### 1. 缺少依赖
```bash
pip3 install requests boto3 rich
```

### 2. AWS凭证问题
确保配置了正确的AWS凭证：
```bash
aws configure
```

### 3. 权限问题
确保有以下权限：
- DynamoDB读取权限
- CloudWatch指标查询权限
- API Gateway调用权限

## 与原版本的区别

| 功能 | 原版本 | 增强版本 |
|------|--------|----------|
| API调用日志 | 简单 | 详细 |
| 响应时间 | 无 | 精确到毫秒 |
| Token详情 | 总计 | 输入/输出分别显示 |
| 阈值进度 | 数值 | 可视化进度条 |
| 错误处理 | 基础 | 详细错误信息 |
| 测试总结 | 简单 | 完整统计报告 |

## 性能影响

增强日志功能对性能影响极小：
- 日志输出：<1ms
- 时间戳生成：<0.1ms
- 进度条计算：<0.1ms

总体延迟增加：<5ms/调用
